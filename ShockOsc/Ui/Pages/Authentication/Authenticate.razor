@using OpenShock.ShockOsc.Ui.Utils
@using OpenShock.SDK.CSharp.Live
@using OpenShock.ShockOsc.Backend
@using OpenShock.ShockOsc.Config
@using OpenShock.ShockOsc.Ui.Components.Layout
@using Microsoft.Extensions.Logging
@inherits LayoutComponentBase

@inject ConfigManager ConfigManager
@inject NavigationManager NavigationManager
@inject BackendLiveApiManager LiveApiManager
@inject OpenShockApiLiveClient LiveApiClient
@inject OpenShockApi ApiClient
@inject ILogger<Authenticate> Logger

@page "/"

<MudThemeProvider Theme="ThemeDefinition.ShockOscTheme"/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<Logo/>

<MudContainer Class="align-content-center" MaxWidth="MaxWidth.Small" Style="padding-top: 30px">
    <MudPaper Id="login-background" Class="rounded-lg" Elevation="0" Style="padding: 40px 20px; text-align: center;">
        <MudText Typo="Typo.h2">Login</MudText>
        <br/>
        @if (!Loading)
        {
            <MudTextField @bind-Value="ConfigManager.Config.OpenShock.Token" Label="API Token" Variant="Variant.Outlined"></MudTextField>
            <br />
            <MudButton OnClick="Login" Variant="Variant.Filled" Color="Color.Primary" Style="float: right;">Continue</MudButton>
            <br />
        }
        else
        {
            <MudProgressCircular Color="Color.Primary" Style="height:125px;width:125px;" Indeterminate="true" />
        }
    </MudPaper>
</MudContainer> 

@code {
    private bool Loading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if(string.IsNullOrEmpty(ConfigManager.Config.OpenShock.Token)) return;

        await ProceedAuthenticated();
    }

    public async Task Login()
    {
        await ConfigManager.SaveAsync();
        ApiClient.SetupApiClient();
        await ProceedAuthenticated();
    }

    private async Task ProceedAuthenticated()
    {
        Loading = true;
        
        Logger.LogInformation("Setting up live client");
        await LiveApiManager.SetupLiveClient();
        Logger.LogInformation("Starting live client");
        await LiveApiClient.StartAsync();
        
        Logger.LogInformation("Refreshing shockers");
        await ApiClient.RefreshShockers();

        NavigationManager.NavigateTo("main");
    }
}